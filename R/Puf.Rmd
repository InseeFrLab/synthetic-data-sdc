---
title: "Enquête Emploi en Continu de 2022"
author: "Julien Helfenstein"
date: "16/07/2024"
output: html_document
---
```{r packages}
if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2"); library(ggplot2)
if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("ddplyr"); library(dplyr)
```
```{r donnees}
BUCKET = "projet-donnees-synthetiques"
FILE_KEY_IN_S3 = "puf_preprocessed.RDS"
data_puf <- aws.s3::s3read_using(
  FUN = readRDS,
  object = FILE_KEY_IN_S3,
  bucket = BUCKET,
  opts = list("region" = "")
)
```

Notre jeu de données est le puf au trimestre 1. 

# Filtres
Cherchons des filtres nous permettant de voir si la synthétisation de notre jeu de données s'est bien passée.

**HEFFEMP et ACTEU = 2 ou 3 :** Une personne ayant un nombre d'heures effectivement travaillées au cours de la semaine de référence ne peut pas être au chômage (ACTEU = 2) ou inactive.
```{r}
table(data_puf$HEFFEMP, data_puf$ACTEU, useNA = "always")
```

**TXTPPRED et TPPRED = 1 :** Si une personne est à temps complet (TPPRED = 1) elle ne peut pas avoir un taux de temps partiel autre que NA.

```{r}
table(data_puf$TXTPPRED, data_puf$TPPRED, useNA = "always")
```

**TRAREF = 1 et ACTEU = 2 ou 3 :** Si une personnes a travaillé au moins une heure pendant la semaine de référence (TRAREF = 1) elle ne peut être au chômage ou inactive (ACTEU = 2 ou 3).

```{r}
table(data_puf$TRAREF, data_puf$ACTEU, useNA = "always")
```

**TRAREF = 9 et ACTEU = 2 ou 3 :** Si une personnes a travaillé au moins une heure pendant la semaine de référence (TRAREF = 1) elle ne peut être au chômage ou inactive (ACTEU = 2 ou 3).

```{r}
table(data_puf$TRAREF, data_puf$ACTEU, useNA = "always")
```

**COUPL_LOG = 1 et TYPLOG = 1 :** Une personne se déclarant en couple avec une personne du logement (COUPL_LOG = 1) ne peut se considérer comme personne seule (TYPLOG5 = 1) sachant qu'il y a comme autre modalité de TYPLOG5 : "Famille monoparentale", "Couple sans enfant", "Couple avec enfant(s)" et "Autre". Cependant on en trouve dans la table originale. On regarde alors les identifiants logement de ces individus pour voir si certains sont dans le même logement ou non.

```{r}
table(data_puf$COUPL_LOG, data_puf$TYPLOG5, useNA = "always")

length(data_puf[data_puf$COUPL_LOG == 1 & data_puf$TYPLOG5 == 1,"IDENT"]) == length(unique(data_puf[data_puf$COUPL_LOG == 1 & data_puf$TYPLOG5 == 1,"IDENT"]))
```

**TEMP = 1 et ACTEU = 2 ou 3 :** Une personne ayant un emploi pendant la semaine de référence (TEMP = 1) ne peut être au chômage (ACTEU = 2) ou inactive (ACTEU = 3).

```{r}
table(data_puf$TEMP, data_puf$ACTEU, useNA = "always")
```

**STATUT = 1 ou 2 et ATCEU = 2 ou 3 :** Si une personne est indéprendante (STATUT = 1) ou salariée (STATUT = 2) elle ne peut être au chômage (ACTEU = 2) ou inactive (ACTEU = 3).

```{r}
table(data_puf$STATUT, data_puf$ACTEU, useNA = "always")
```

**STATUTDET et ACTEU = 2 ou 3 :** Même raison qu'au dessus.

```{r}
table(data_puf$STATUTDET, data_puf$ACTEU, useNA = "always")
```

**STC et ACTEU = 2 ou 3 :** Même raison qu'au dessus.

```{r}
table(data_puf$STC, data_puf$ACTEU, useNA = "always")
```

**SALTYP et ACTEU = 2 ou 3 :** Une personne au chômage (ACTEU = 2) ou inactive (ACTEU = 3) doit répondre NA quand on lui demande la nature du contrat pour son emploi principal (SALTYP).

```{r}
table(data_puf$SALTYP, data_puf$ACTEU, useNA = "always")
```

**TPPRED = 1 et RAISTP :** Si une personne est en temps complet (TPPRED = 1) elle ne peut donner de raison principale de temps partiel (RAISTP).

```{r}
table(data_puf$TPPRED, data_puf$RAISTP, useNA = "always")
```

**PUB3FP et ACTEU = 2 ou 3 :** Une personne au chômage (ACTEU = 2) ou inactive (ACTEU = 3) ne peut donner le statut public ou privé de l'employeur (PUB3FP).

```{r}
table(data_puf$PUB3FP, data_puf$ACTEU, useNA = "always")
```

**PASTRA = 1 et ACTEU = 2 ou 3 :** Une personne n'ayant pas travaillé la semaine de référence mais ayant un emploi rémunéré (PASTRA = 1) ne devrait pas être au chômage (ACTEU = 2) ou inactive (ACTEU = 3). Cependant, on en trouve dans la table originale.

```{r}
table(data_puf$PASTRA, data_puf$ACTEU, useNA = "always")
```

**ANCSSEMP = 1 et ACTEU = 1 :** Une personne en emploi (ACTEU = 1) doit répondre NA lorsqu'on lui demande l'ancienneté sans emploi (ANCSSEMP).

```{r}
table(data_puf$ANCSSEMP, data_puf$ACTEU, useNA = "always")
```

**CHPUB et ACTEU = 2 ou 3 :** Une personne au chômage (ACTEU = 2) ou inactive (ACTEU = 3) ne peut donner la nature l'employeur (CHPUB).

```{r}
table(data_puf$CHPUB, data_puf$ACTEU, useNA = "always")
```

**CL_EMPLOI et ACTEU = 2 ou 3 :** Une personne au chômage (ACTEU = 2) ou inactive (ACTEU = 3) ne peut donner la classe d'emploi de l'emploi principal (CL_EMPLOI).

```{r}
table(data_puf$CL_EMPLOI, data_puf$ACTEU, useNA = "always")
```

# Synthétisation
On synthétise les variables suivantes : ACTEU, AGE6, COUPL_LOG, NAFG004UN, NAFG010UN, NAFG017UN, TYPLOG5

```{r effectifs}
variables <- c("ACTEU", "AGE6", "COUPL_LOG", "NAFG004UN", "NAFG010UN", "NAFG017UN", "TYPLOG5")
liste_graph <- list()

for (i in 1:length(variables)) {
  freq_puf_mod <- puf_mod %>%
    count(.data[[variables[i]]]) %>%
    rename(effectif = n) %>%
    mutate(dataset = "Original")
  
  freq_syn_puf_mod <- syn_puf_mod$syn %>%
    count(.data[[variables[i]]]) %>%
    rename(effectif = n) %>%
    mutate(dataset = "Synthétique")
  
  freq_combined <- bind_rows(freq_puf_mod, freq_syn_puf_mod)
  
  plt <- ggplot(freq_combined, aes(x = .data[[variables[i]]], y = effectif, fill = dataset)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    labs(title = paste("Comparaison des effectifs de", variables[i]),
         x = variables[i],
         y = "Effectif",
         fill = "Jeu de données") +
    scale_fill_manual(values = c("Original" = "#1A3C5A", "Synthétique" = "#4187BF")) +
    theme_minimal()
  
  liste_graph[[i]] <- plt
}
print(liste_graph)
```

```{r pMSE}
pMSE_syn_puf_mod <- utility.gen(syn_puf_mod$syn, puf_mod)$pMSE
print(pMSE_syn_puf_mod)

utility.tables(syn_puf_mod, puf_mod, tab.stats = "pMSE", plot.stat = "pMSE")
```

```{r}
print("ACTEU en fonction de NAFG004UN - original")
print(table(puf_mod$ACTEU,puf_mod$NAFG004UN, useNA = "always"))
print("ACTEU en fonction de NAFG004UN - synthétique")
print(table(syn_puf_mod$syn$ACTEU,syn_puf_mod$syn$NAFG004UN, useNA = "always"))
```
On constate que les personnes en emploi (ACTEU = 1) ont toutes répondues et que les personnes au chômage (ACTEU = 2) et inactives (ACTEU = 3) n'ont pas répondues.

```{r}
print("NAFG010UN en fonction de NAFG004UN - original")
print(table(puf_mod$NAFG010UN,puf_mod$NAFG004UN, useNA = "always"))
print("NAFG010UN en fonction de NAFG004UN - synthétique")
print(table(syn_puf_mod$syn$NAFG010UN,syn_puf_mod$syn$NAFG004UN, useNA = "always"))
```
On ne remarque aucune incohérence.

















